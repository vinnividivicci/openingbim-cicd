# Data Model: Direct IFC to IDS Validation Workflow

**Feature**: 001-ids-validation-via
**Date**: 2025-10-03
**Source**: Extracted from feature specification and research findings

---

## Entities

### 1. UploadedFile

Represents a file uploaded by the user and stored temporarily in the system.

**Fields**:
- `fileId`: string (UUID) - Unique identifier for the file
- `originalName`: string - Original filename provided by user
- `size`: number - File size in bytes
- `mimeType`: string - MIME type (e.g., "application/x-step", "application/xml")
- `buffer`: Buffer - File contents in memory (for active processing)
- `path`: string - Physical file path on disk (for cached files)
- `uploadTimestamp`: Date - When the file was uploaded
- `expiryTimestamp`: Date - When the file will be automatically deleted (uploadTimestamp + 1 hour)

**Validation Rules**:
- `size` ≤ 1,073,741,824 bytes (1 GB)
- `originalName` must have valid extension (.ifc, .ids, .xml, .frag)
- `expiryTimestamp` must be exactly 1 hour after `uploadTimestamp`

**Lifecycle**:
```
uploaded → active (in fileRegistry) → expired (auto-deleted by cleanup timer)
```

**Storage Location**:
- Disk: `temp/storage/{type}/{fileId}{ext}`
- Registry: `Map<fileId, StoredFile>`

**References**:
- Used by: ValidationJob, CachedIFC, FragmentsJob
- Managed by: FileStorageService

---

### 2. ValidationJob

Represents an IDS validation task in progress or completed.

**Fields**:
- `jobId`: string (UUID) - Unique identifier for the validation job
- `ifcFileId`: string - Reference to UploadedFile (IFC model)
- `idsFileId`: string - Reference to UploadedFile (IDS specification)
- `cachedIfcFileId`: string | null - Reference to cached IFC file (for later visualization)
- `status`: "queued" | "processing" | "completed" | "failed"
- `createdAt`: Date - When the validation job was created
- `completedAt`: Date | null - When the job finished (success or failure)
- `resultsFileId`: string | null - Reference to validation results file (if completed)
- `error`: ValidationError | null - Error information (if failed)

**Validation Rules**:
- `ifcFileId` and `idsFileId` must reference existing UploadedFile entities
- `status` transitions: queued → processing → (completed | failed)
- `completedAt` must be set when status changes to "completed" or "failed"
- `resultsFileId` must be set when status is "completed"
- `error` must be set when status is "failed"

**State Transitions**:
```
created (queued) → processing (Python subprocess spawned) → completed (results available)
                                                           → failed (error captured)
```

**Storage Location**:
- Registry: `Map<jobId, Job>` in JobQueue service
- Results: `temp/storage/validation-results/{resultsFileId}.json`

**References**:
- References: UploadedFile (IFC), UploadedFile (IDS), UploadedFile (cached IFC), UploadedFile (results)
- Referenced by: FragmentsJob (via validationJobId link)
- Managed by: JobQueue, IfcTesterService

---

### 3. ValidationResults

Represents the output of an IDS validation run (stored as JSON).

**Fields**:
- `specifications`: Array<SpecificationResult> - Results for each IDS specification
  - `name`: string - Specification name
  - `applicability`: string - Applicability description
  - `requirements`: Array<RequirementResult> - Results for each requirement
    - `description`: string - Requirement description
    - `passed`: number - Count of passed entities
    - `failed`: number - Count of failed entities
    - `failed_entities`: string[] | undefined - List of failed entity IDs
- `summary`: ValidationSummary - Overall validation summary
  - `total_specifications`: number - Total number of specifications checked
  - `total_requirements`: number - Total number of requirements checked
  - `passed`: number - Total passed count
  - `failed`: number - Total failed count
- `error`: string | undefined - Error message (if validation failed)
- `message`: string | undefined - Additional informational message

**Validation Rules**:
- `specifications` array must not be empty if validation succeeded
- `summary.total_specifications` must equal `specifications.length`
- `summary.passed + summary.failed` must equal total entity count checked
- If `error` is set, `specifications` may be empty

**Storage Format**: JSON file at `temp/storage/validation-results/{fileId}.json`

**References**:
- Referenced by: ValidationJob (via resultsFileId)
- Generated by: IfcTesterService (Python subprocess output)

---

### 4. CachedIFC

Represents an IFC file cached for potential later visualization (after validation completes).

**Fields**:
- `cacheId`: string (UUID) - Unique identifier for the cache entry
- `ifcFileId`: string - Reference to UploadedFile (the cached IFC file)
- `validationJobId`: string | null - Reference to ValidationJob (if this IFC was validated)
- `cachedAt`: Date - When the IFC file was cached
- `expiresAt`: Date - When the cache entry expires (cachedAt + 1 hour)
- `metadata`: CacheMetadata - Additional cache information
  - `originalFilename`: string
  - `fileSize`: number
  - `validationCompleted`: boolean

**Validation Rules**:
- `ifcFileId` must reference existing UploadedFile with MIME type "application/x-step"
- `expiresAt` must be exactly 1 hour after `cachedAt`
- `validationJobId` must reference existing ValidationJob (if not null)

**State Transitions**:
```
created (after validation) → active (available for retrieval) → expired (auto-deleted)
```

**Storage Location**:
- IFC file: `temp/storage/ifc-cache/{ifcFileId}.ifc`
- Metadata: `Map<cacheId, CachedIFC>` in FileStorageService

**References**:
- References: UploadedFile (IFC), ValidationJob (optional)
- Referenced by: FragmentsJob (when visualization requested)
- Managed by: FileStorageService

---

### 5. FragmentsJob

Represents an IFC-to-fragments conversion task for visualization.

**Fields**:
- `jobId`: string (UUID) - Unique identifier for the conversion job
- `ifcFileId`: string - Reference to UploadedFile (IFC source file)
- `validationJobId`: string | null - Reference to ValidationJob (if linking validation results)
- `status`: "queued" | "processing" | "completed" | "failed"
- `createdAt`: Date - When the conversion job was created
- `completedAt`: Date | null - When the job finished
- `fragmentsFileId`: string | null - Reference to generated fragments file
- `error`: ConversionError | null - Error information (if failed)

**Validation Rules**:
- `ifcFileId` must reference existing UploadedFile or CachedIFC
- `status` transitions: queued → processing → (completed | failed)
- `fragmentsFileId` must be set when status is "completed"
- `error` must be set when status is "failed"

**State Transitions**:
```
created (queued) → processing (web-ifc conversion) → completed (fragments available)
                                                    → failed (error captured)
```

**Storage Location**:
- Registry: `Map<jobId, Job>` in JobQueue service
- Fragments output: `temp/storage/fragments/{fragmentsFileId}.frag`

**References**:
- References: UploadedFile (IFC) or CachedIFC, ValidationJob (optional)
- Managed by: JobQueue, DirectFragmentsService

---

### 6. ValidationError

Represents error information when validation fails.

**Fields**:
- `type`: string - Error type category (e.g., "InvalidIFCStructure", "PythonServiceUnavailable")
- `reason`: string - Brief human-readable explanation
- `timestamp`: Date - When the error occurred

**Examples**:
```typescript
{
  type: "InvalidIFCStructure",
  reason: "Missing required IFC entity IFCPROJECT",
  timestamp: new Date("2025-10-03T14:30:00Z")
}

{
  type: "FileSizeExceeded",
  reason: "File exceeds 1 GB limit",
  timestamp: new Date("2025-10-03T14:35:00Z")
}

{
  type: "PythonServiceUnavailable",
  reason: "Python ifctester package not installed",
  timestamp: new Date("2025-10-03T14:40:00Z")
}
```

**Validation Rules**:
- `type` must be a PascalCase identifier
- `reason` must be concise (≤ 100 characters recommended)
- Conforms to FR-010 requirement for error type + brief reason

**References**:
- Used by: ValidationJob, FragmentsJob

---

### 7. ConversionError

Represents error information when IFC-to-fragments conversion fails.

**Fields**:
- `type`: string - Error type category (e.g., "WASMLoadFailed", "InvalidGeometry")
- `reason`: string - Brief human-readable explanation
- `timestamp`: Date - When the error occurred

**Examples**:
```typescript
{
  type: "WASMLoadFailed",
  reason: "web-ifc WASM module failed to load",
  timestamp: new Date("2025-10-03T15:00:00Z")
}

{
  type: "InvalidGeometry",
  reason: "IFC geometry parsing failed at entity #123",
  timestamp: new Date("2025-10-03T15:05:00Z")
}
```

**Validation Rules**:
- Same as ValidationError (consistent error format across the system)

**References**:
- Used by: FragmentsJob

---

## Relationships

```
UploadedFile ←──┬── ValidationJob ──→ ValidationResults
                │        ↓
                │   cachedIfcFileId
                │        ↓
                └── CachedIFC ←── FragmentsJob ──→ Fragments File
                         ↑              ↓
                         └── validationJobId (optional link)
```

**Key Relationships**:
1. ValidationJob references TWO UploadedFiles: one IFC file, one IDS file
2. ValidationJob creates CachedIFC (links via cachedIfcFileId)
3. CachedIFC optionally links back to ValidationJob (for result retrieval)
4. FragmentsJob can reference CachedIFC to reuse uploaded IFC file
5. FragmentsJob optionally links to ValidationJob to associate visualization with results

**Lifecycle Dependencies**:
- UploadedFile must exist before ValidationJob or FragmentsJob can be created
- CachedIFC must exist (and not expired) for later FragmentsJob to reuse IFC file
- Auto-deletion of UploadedFile/CachedIFC after 1 hour breaks references (jobs become historical records with broken file links)

---

## State Transition Diagrams

### UploadedFile States
```
┌──────────┐    upload    ┌────────┐    1 hour    ┌─────────┐
│ (none)   │─────────────→│ active │─────────────→│ expired │
└──────────┘              └────────┘              └─────────┘
                              ↓                         ↓
                          in fileRegistry        auto-deleted
```

### ValidationJob States
```
┌─────────┐    create     ┌──────────┐    start     ┌────────────┐
│ (none)  │──────────────→│  queued  │─────────────→│ processing │
└─────────┘               └──────────┘              └────────────┘
                                                           ↓
                                                  ┌────────┴────────┐
                                                  ↓                 ↓
                                            ┌───────────┐     ┌──────────┐
                                            │ completed │     │  failed  │
                                            └───────────┘     └──────────┘
                                                  ↓                 ↓
                                            resultsFileId        error set
```

### CachedIFC States
```
┌──────────┐   validation    ┌────────┐    1 hour    ┌─────────┐
│ (none)   │    completes    │ active │─────────────→│ expired │
└──────────┘─────────────────→└────────┘              └─────────┘
                                  ↓                        ↓
                            available for           auto-deleted
                            visualization
```

### FragmentsJob States
```
┌─────────┐    create     ┌──────────┐    start     ┌────────────┐
│ (none)  │──────────────→│  queued  │─────────────→│ processing │
└─────────┘               └──────────┘              └────────────┘
                                                           ↓
                                                  ┌────────┴────────┐
                                                  ↓                 ↓
                                            ┌───────────┐     ┌──────────┐
                                            │ completed │     │  failed  │
                                            └───────────┘     └──────────┘
                                                  ↓                 ↓
                                          fragmentsFileId      error set
```

---

## Data Validation Summary

| Entity | Primary Key | Required Fields | Constraints |
|--------|-------------|-----------------|-------------|
| UploadedFile | fileId (UUID) | originalName, size, mimeType, uploadTimestamp, expiryTimestamp | size ≤ 1GB, expiry = upload + 1h |
| ValidationJob | jobId (UUID) | ifcFileId, idsFileId, status, createdAt | status transitions valid, completedAt set on completion |
| ValidationResults | (embedded in file) | specifications, summary | summary.total_* must match array lengths |
| CachedIFC | cacheId (UUID) | ifcFileId, cachedAt, expiresAt | expiry = cached + 1h |
| FragmentsJob | jobId (UUID) | ifcFileId, status, createdAt | status transitions valid, completedAt set on completion |
| ValidationError | (embedded) | type, reason, timestamp | type is PascalCase, reason ≤ 100 chars |
| ConversionError | (embedded) | type, reason, timestamp | type is PascalCase, reason ≤ 100 chars |

---

*Data model extracted from feature specification and research findings*
*Ready for contract generation and implementation*
